# Nemotron-Instagram ワークフローガイド

## 全体フロー概要

```
ユーザー入力
    ↓
【Nemotron選定】
    ↓
【キーワード生成】
    ↓
【Instagram API】
    ↓
【データ統合】
    ↓
【信頼性評価】
    ↓
Markdownレポート
```

## 各ステップ詳細

### ステップ1: Nemotron ペルソナ選定

**目的**: 1M件のNemotronデータから最適なペルソナを選定

**処理内容**:
1. ユーザー入力をパース (年齢、職業、地域等を抽出)
2. フィルタリング適用
   - 年齢範囲
   - 職業キーワード
   - 都道府県
   - キャリア目標
3. 関連性スコアリング (0-100点)
   - 年齢一致: 20点
   - 職業一致: 30点
   - キャリア目標一致: 20点
   - 趣味・スキル一致: 15点
   - 地域一致: 15点
4. 多様性確保
   - 同一職業: 最大2件
   - 同一都道府県: 最大2件
   - 年齢分散: ±3歳以内は1件のみ

**出力**:
- ペルソナリスト (スコア降順)
- 各ペルソナの基本属性 (年齢、職業、地域、キャリア目標、趣味等)

**エラーハンドリング**:
- フィルタ結果0件 → 条件緩和提案
- データセット読み込み失敗 → キャッシュ確認

---

### ステップ2: Instagram キーワード生成

**目的**: Nemotronペルソナ属性からInstagram検索キーワードを自動生成

**処理内容**:
1. 優先度付きキーワード抽出
   - 優先順位1: 職業 + キャリア目標
   - 優先順位2: 趣味・興味
   - 優先順位3: スキル
   - 優先順位4: 年齢・地域
2. 言語バランス調整
   - 日本語: 70%
   - 英語: 30%
3. ハッシュタグフォーマット化
4. 検索クエリ生成 (単一キーワード + 組み合わせ)

**出力**:
- キーワードリスト (最大15件)
- Apify API入力フォーマット
  - `hashtags`: ハッシュタグリスト
  - `search_queries`: 検索クエリリスト

**エラーハンドリング**:
- キーワード0件 → 汎用キーワード使用
- マッピングファイル読み込み失敗 → デフォルト値使用

---

### ステップ3: Instagram データ取得 (Apify API)

**目的**: 実際のInstagram投稿・プロフィールデータを取得

**処理内容**:
1. Actor実行 (`apify/instagram-scraper`)
   - 検索クエリ: 生成キーワード
   - 投稿数: キーワードあたり最大20件
   - プロフィール数: 最大10件
2. ジョブ完了待機 (最大180秒)
3. データセット取得
4. 重複削除
   - 投稿ID重複チェック
   - プロフィールID重複チェック

**出力**:
- 投稿リスト
  - キャプション、ハッシュタグ、いいね数、コメント数等
- プロフィールリスト
  - ユーザー名、フォロワー数、投稿数、バイオ等

**エラーハンドリング**:
- API認証失敗 → トークン確認メッセージ
- タイムアウト → リトライまたはスキップ
- ジョブ失敗 → Nemotronのみで続行 (信頼性スコア低下)

---

### ステップ4: データ統合

**目的**: Nemotronペルソナとインスタグラムデータを統合

**処理内容**:
1. ベースライン抽出 (Nemotron)
   - 基本情報 (年齢、性別、居住地)
   - デモグラフィック (職業、学歴、婚姻状況)
   - キャリア情報 (目標、スキル)
   - ライフスタイル (趣味、興味)

2. Instagramエンリッチメント
   - プロフィール情報 (代表的なユーザー3名)
   - 投稿分析
     - 主要トピック
     - 頻出ハッシュタグ (上位10件)
     - エンゲージメント平均 (いいね、コメント)
   - 実際の悩み抽出
     - 悩みキーワード含む投稿 (上位5件)

3. 矛盾チェック
   - 年齢と投稿内容の整合性
   - 職業とハッシュタグの整合性

**出力**:
- 統合ペルソナ辞書
- 矛盾チェック結果

**エラーハンドリング**:
- Instagram データなし → Nemotronのみで統合
- 矛盾検出 → 警告付きで続行

---

### ステップ5: 信頼性評価

**目的**: 統合ペルソナの信頼性を100点満点で評価

**配点ロジック**:

| 項目 | 配点 | 条件 |
|------|------|------|
| **Nemotron統計的裏付け** | 40点 | Nemotronペルソナ存在 |
| **Instagram投稿数** | 最大30点 | 50投稿以上=30点、20投稿以上=20点、10投稿以上=10点 |
| **Instagramプロフィール数** | 最大10点 | 10プロフィール以上=10点、5プロフィール以上=5点 |
| **整合性** | 最大20点 | 矛盾なし=20点、軽微な矛盾=10点 |

**信頼性レベル**:
- **80-100点**: 高信頼性 (採用推奨)
- **60-79点**: 中信頼性 (条件付き採用)
- **40-59点**: 低信頼性 (追加検証推奨)
- **0-39点**: 不完全 (通常は発生しない)

**出力**:
- 信頼性スコア (0-100)
- レベル判定結果

---

### ステップ6: Markdown レポート生成

**目的**: 人間が読みやすいMarkdownレポート生成

**レポート構成**:

```markdown
# Nemotron-Instagram ペルソナ分析レポート

**ターゲット**: {ユーザー入力}
**分析日時**: YYYY-MM-DD HH:MM:SS

## データソース
- Nemotron ペルソナ: X件選定
- Instagram 投稿: Y件取得
- Instagram プロフィール: Z件取得

## 統合結果サマリー
- 統合ペルソナ数: N件
- 平均信頼性スコア: XX.X/100
  - 高信頼性 (80-100点): N件
  - 中信頼性 (60-79点): N件
  - 低信頼性 (0-59点): N件

---

## ペルソナ 1

### 信頼性スコア: 85/100

### 基本情報
- 年齢: 28歳
- 性別: 男性
- 居住地: 東京都 (関東)

### デモグラフィック
- 職業: ITエンジニア
- 学歴: 大学卒業
- 婚姻状況: 未婚

### キャリア情報
- キャリア目標: フリーランスとして独立...
- スキル: Python, AWS, Docker...

### Instagram 投稿分析
- 投稿数: 52件
- 頻出ハッシュタグ: #ITエンジニア, #転職, #キャリアチェンジ
- 平均いいね数: 125.3
- 平均コメント数: 8.7

### 実際の悩み・課題
1. 転職活動でスキルの棚卸しに苦労...
2. 現職の将来性に不安...

### データソース
- Nemotron ペルソナ: ✅
- Instagram データ: ✅

### 整合性チェック
- ✅ 矛盾なし

---

## ペルソナ 2
...
```

**出力形式**:
- Markdown文字列
- ファイル保存 (オプション)

---

## パフォーマンス最適化

### 並列処理
- 複数キーワードの同時検索 (将来実装)
- Instagram API並列呼び出し

### キャッシュ活用
- Nemotronデータセット初回ロードのみ
- Instagram API結果のキャッシュ (将来実装)

### タイムアウト管理
- Instagram API: 180秒
- ジョブ完了待機: 10秒間隔ポーリング

---

## エラーハンドリング戦略

### レベル1: 警告 (処理続行)
- キーワード生成0件
- Instagram データ部分失敗
- 軽微な矛盾検出

### レベル2: フォールバック
- Instagram API完全失敗 → Nemotronのみで続行
- Nemotronフィルタ0件 → 条件緩和提案

### レベル3: エラー終了
- APIFY_TOKEN未設定
- Nemotronデータセット読み込み失敗
- 全ペルソナが最低信頼性スコア未満

---

## ユースケース別推奨設定

### 1. 高精度分析 (時間かかる)
```python
pipeline.run(
    target_description="30代のITエンジニア",
    max_personas=5,
    max_posts_per_keyword=50,
    max_profiles=20,
    min_trust_score=80
)
```

### 2. 標準分析 (バランス型)
```python
pipeline.run(
    target_description="30代のITエンジニア",
    max_personas=3,
    max_posts_per_keyword=20,
    max_profiles=10,
    min_trust_score=60
)
```

### 3. 高速分析 (速度優先)
```python
pipeline.run(
    target_description="30代のITエンジニア",
    max_personas=1,
    max_posts_per_keyword=10,
    max_profiles=5,
    min_trust_score=40
)
```

---

## 次のステップ

分析完了後、以下のアクションを推奨:

1. **信頼性スコア80点以上のペルソナ**: 即座に採用
2. **信頼性スコア60-79点のペルソナ**: 追加Instagram検索で検証
3. **信頼性スコア60点未満のペルソナ**: 再分析またはターゲット再定義

---

*詳細な品質基準は `quality_criteria.md` を参照*
*トラブルシューティングは `troubleshooting.md` を参照*
