# FirstScope（firstrade-calculator-app）プロジェクト解説

## 概要

**FirstScope** は、米国証券会社 Firstrade を利用する日本在住者向けの **確定申告支援Webアプリケーション** です。

Vibeコーディング（AIとの対話ベースの開発手法）を活用し、**わずか2日間でベースアプリを構築** しました。その後、為替レート管理やライセンス認証などの機能を段階的に追加し、現在のバージョン（v1.5.0）に至っています。

---

## 1. プロジェクトの目的

### 確定申告用の計算ツール

このアプリは **確定申告** を主な目的として開発しました。具体的には以下の課題を解決します。

| 課題 | 解決策 |
|------|--------|
| Firstradeの取引履歴CSVが英語＆ドル建てで、日本の確定申告に使いにくい | CSVをアップロードするだけで日本円換算＆月別集計を自動化 |
| 配当金の受取日ごとに為替レートを調べるのが面倒 | ECB公式レートを自動取得し、日付ごとに正確な円換算を実行 |
| 売買損益の計算で、取得日と売却日それぞれの為替レートが必要 | 両方のレートを自動取得し、日本方式（個別換算）と米国方式（一括換算）の2通りで計算 |
| Wash Sale（損失の繰り延べ）ルールの扱いが複雑 | Wash Sale調整額を自動反映した損益計算を提供 |

加えて、**ポートフォリオ分析**（目標アロケーションとの乖離分析）や**税金シミュレーター**も搭載しており、日々の資産管理ツールとしても活用できます。

---

## 2. 技術スタック

### フロントエンド

| 技術 | バージョン | 選定理由 |
|------|-----------|---------|
| **Next.js** | 15 (App Router) | SSR/SSG対応、APIルート統合、React Server Components |
| **React** | 19 | 最新のReactで非同期UIを効率的に構築 |
| **TypeScript** | 5.7 | CSV→型付きオブジェクトの変換で型安全性を確保 |
| **Tailwind CSS** | 3.4 | ユーティリティファーストで素早くUI構築 |
| **shadcn/ui** | - | アクセシブルなUIコンポーネント（Dialog, Card, Accordion等） |
| **Recharts** | 2.12 | 月別損益グラフの可視化 |
| **react-dropzone** | 14.3 | ドラッグ＆ドロップでのCSVファイルアップロード |

### バックエンド・インフラ

| 技術 | 用途 |
|------|------|
| **Next.js API Routes** | ライセンス検証、為替レート取得のAPIエンドポイント |
| **Frankfurter API** | ECB（欧州中央銀行）公式の為替レート取得 |
| **Gumroad API** | ライセンスキー検証（有料機能のゲーティング） |
| **Google Cloud Run** | Dockerコンテナでのデプロイ |
| **Cloud Build** | CI/CDパイプライン |

### 開発ツール

| ツール | 用途 |
|--------|------|
| **Jest + React Testing Library** | ユニットテスト |
| **ESLint** | コード品質チェック |
| **PapaParse** | CSVパース（解析） |

---

## 3. 主要機能と技術的な工夫

### 3.1 配当金計算機能（`/dividend`）

**処理フロー:**
```
CSVアップロード → PaParseで解析 → レコード分類 → 為替レート取得 → 円換算 → 月別集計
```

**工夫点:**
- **源泉徴収額の自動抽出**: CSVの Description フィールドから正規表現（`/WITHHELD\s+\$?(\d+,?\d*\.?\d*)/i`）でパース
- **プログレスインジケーター**: 為替レート取得中（0-80%）→ データ分類中（80-90%）→ 完了（100%）の3段階で進捗を表示し、処理が止まっていないことを明示

### 3.2 売買損益計算機能（`/gainloss`）

**処理フロー:**
```
CSVアップロード → ヘッダー正規化 → 数値クリーニング → 型変換 → 為替レート取得 → 損益計算 → 月別集計
```

**工夫点:**
- **2段階CSV処理アーキテクチャ**:
  - Phase 1（前処理）: ヘッダーマッピング＋数値フォーマット正規化
  - Phase 2（本処理）: 型付きオブジェクトへの変換＋ビジネスロジック
- **日本方式と米国方式の2通りの計算**:
  ```
  日本方式: (売却額 × 売却日レート) - (取得額 × 取得日レート)
  米国方式: USD損益 × 売却日レート
  ```

### 3.3 CSVパース処理の工夫

**最も苦労した点**: Firstradeが出力するCSVのヘッダーが一貫していない問題への対応。

```typescript
// ヘッダーマッピングで揺れを吸収
const HEADER_MAPPINGS = {
  'TradeDate': ['Date Sold'],
  'PurchaseDate': ['Date Acquired'],
  'Proceeds': ['Sales Proceeds'],
  'Cost': ['Adjust Cost'],
  'WashSale': ['Wash Sale', 'Wash Sale Loss Disallowed', ...]
};

// 大文字小文字・記号の違いを無視してマッチング
function normalizeHeader(header: string): string { ... }
```

**数値クリーニング**: CSVに含まれる `$1,234.56` や `¥148,500` といった通貨記号・カンマ付き数値を統一的にパースする `cleanNumber()` ユーティリティを全機能で共通利用。

### 3.4 為替レート管理の工夫

**こだわった点**: 為替レートの取得は単純に見えて、実際には多くのエッジケースがあります。

**スマートフォールバック戦略（6段階）:**
1. メモリキャッシュを確認
2. 指定日のレートを検索
3. 直前の営業日にフォールバック（土日・祝日対応）
4. 同一四半期内の直近レートを検索
5. 前四半期の最終レートを検索
6. 最大4四半期遡って検索
7. デフォルトレート（150.0円）をフォールバック値として使用（警告付き）

**四半期別ファイル分割**: 為替レートデータを四半期ごとのJSONファイルに分割保管。
```
public/data/
├── current/          # 今期（例: 2026Q1.json）
└── historical/       # 過去（例: 2025/Q1.json）
```
これにより、1ファイルあたりのサイズを小さく保ちつつ、過去データのアーカイブも容易に。

### 3.5 ライセンス管理とデモモード

- **有料機能**: CSVエクスポート（確定申告用データの書き出し）はGumroadでライセンスキーを購入したユーザーのみ利用可能
- **デモモード**: 内蔵のデモデータを使えば、ライセンスなしで全機能を試用可能
- **プライバシー配慮**: ユーザーの金融データはサーバーに送信せず、すべてブラウザ内（localStorage）で処理

---

## 4. 型安全なデータ変換パイプライン

TypeScriptの型システムを活用し、CSVの生データから最終出力まで段階的に型を付与しています。

```
RawCSVString
  ↓ PapaParse
RawDividendData (string型の各フィールド)
  ↓ cleanNumber() + 型変換
ConvertedDividendRecord (number型の金額フィールド)
  ↓ 為替レート適用 + 分類
ProcessedDividendData (JPY金額 + カテゴリ分類済み)
```

この段階的な型変換により、各処理段階でのデータ不整合を型チェックで早期発見できます。

---

## 5. アーキテクチャ図

```
┌─────────────────────────────────────────────┐
│                 ブラウザ                      │
│  ┌──────────┐  ┌──────────┐  ┌───────────┐  │
│  │  配当金   │  │ 売買損益  │  │ポートフォリオ│ │
│  │ 計算機能  │  │ 計算機能  │  │  分析機能   │  │
│  └────┬─────┘  └────┬─────┘  └─────┬─────┘  │
│       │             │              │         │
│  ┌────▼─────────────▼──────────────▼─────┐   │
│  │         共通ユーティリティ層            │   │
│  │  cleanNumber() / formatters / logger  │   │
│  └────────────────┬──────────────────────┘   │
│                   │                          │
│  ┌────────────────▼──────────────────────┐   │
│  │          localStorage                  │   │
│  │  (処理結果のセッション保持)              │   │
│  └────────────────────────────────────────┘   │
└──────────────────┬────────────────────────────┘
                   │ API呼び出し
┌──────────────────▼────────────────────────────┐
│           Next.js API Routes                   │
│  ┌─────────────┐  ┌──────────────────────┐    │
│  │ /api/license │  │ /api/exchange-rates  │    │
│  │   /verify    │  │                      │    │
│  └──────┬──────┘  └──────────┬───────────┘    │
└─────────┼────────────────────┼────────────────┘
          │                    │
    ┌─────▼─────┐    ┌────────▼────────┐
    │  Gumroad  │    │ Frankfurter API │
    │   API     │    │  (ECBレート)     │
    └───────────┘    └─────────────────┘
```

---

## 6. Vibeコーディングで得られた成果

### 2日間で構築したベースアプリの範囲
- CSVアップロード＆パース機能
- 配当金の円換算計算
- 売買損益の基本計算
- UIレイアウト（Tailwind CSS + shadcn/ui）
- Next.js App Routerによるページ構成

### その後の段階的な機能拡張
- 為替レートの四半期別管理システム
- Gumroadライセンス認証統合
- ポートフォリオ分析機能（Beta）
- 税金シミュレーター
- AIチャットサポート
- Google Cloud Runへのデプロイ構成
- Wash Sale対応

---

## 7. ポートフォリオとしてのアピールポイント

| 観点 | アピール内容 |
|------|-------------|
| **課題解決力** | 確定申告という実務課題を技術で解決。自分自身がユーザーとして使うツールを開発 |
| **金融リテラシー × 技術力** | 為替レート、配当課税、Wash Saleルールなどの金融知識をコードに落とし込んだ |
| **AI活用力** | Vibeコーディングで2日間でベースアプリを構築。AIとの協働による高速プロトタイピング |
| **型安全な設計** | CSV（非構造化データ）→ TypeScript型付きオブジェクトへの段階的変換パイプライン |
| **エッジケース対応** | 為替レートの6段階フォールバック、CSVヘッダーの揺れ吸収など、実運用で必要な堅牢性 |
| **収益化設計** | Gumroadとの統合でライセンス販売。デモモードで試用→有料機能への導線を設計 |
| **フルスタック構成** | フロント（React/Next.js）＋ バックエンド（API Routes）＋ インフラ（Cloud Run） |
